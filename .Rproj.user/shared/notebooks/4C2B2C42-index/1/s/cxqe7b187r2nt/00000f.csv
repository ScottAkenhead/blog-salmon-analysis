"0","#| warning: false"
"0",""
"0","GssqAll <- function(par, dat){"
"0","    # dat columns: year, day, count"
"0","    # par is 9 parameters"
"0","    eta <- par[1:4]; # abundance each year, length 4"
"0","    mu <- par[5:8]; # timing  each year, length 4"
"0","    sigma <- par[9]; # spread every yearr, length 1"
"0","    years = unique(dat[,1]) # 1996 to 1999"
"0","    ybar <- numeric(length(dat[,1])) # the predicted, length 21"
"0","    m = 0  # starting index for output vector ybar"
"0","    for (j in 1:length(years)) {  # 4 years: 1996 to 1999"
"0","        k <- which(dat[,1] == years[j]) # find rows in dat for each year"
"0","        for (i in k){ # each observed day in that year"
"0","            m <- m+1 # advance index for output"
"0","            ybar[m]  <- eta[j] * dnorm(dat[m,2],mu[j],sigma)"
"0","            # predicted: abundance times normal(day, timing, spread)"
"0","        }"
"0","    }"
"0","    ssq <- sum( (dat[,3]-ybar)^2) # result of trial values for par"
"0","    return(ssq)"
"0","}"
"0","# par is total abundance 4 years:eta; timing 4 years: mu, and "
"0","# spread for all years: sigma. total 9 parameters."
"0","par <-  numeric(9)"
"0","# starting guess for search is eta = 2 * sigma * max, mu = 15, sigma=4"
"0","# max for each year is from observed counts."
"0","par[1:4] <- c(2*4.3*11000, 2*4.3*4100, 2*4.3*700, 2*4.3*4100)"
"0","#  result: 94600 35260  6020 35260"
"0","#  start for yearly timing (mu) is day of observed maximum"
"0","par[5:8] <- c(15,15,19,15)"
"0","# start for spread, sigma, is from preceding fit."
"0","par[9] <- 4.3"
"0","# the required precision of fit, reltol, is reduced from the default."
"0","Gfit <- optim(par, GssqAll, dat=dat[,1:3], control=list(reltol=0.01) )"
"0","par = Gfit$par; # fitted parameters"
"0","pr = round(par, 2) # rounded for printing."
"0","a <- data.frame (Year=1996:1999,eta=pr[1:4],mu=pr[5:8], sigma=pr[9])"
"0","kbl(a)"
